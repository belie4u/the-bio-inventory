import{r as d,bP as ge,i as t,j as s,G as z,bT as Ce,bK as Re,bL as we,as as ee,B as u,Y as Se,I as Te,bV as te,cI as se,eD as ae,ar as ie,aV as le,aY as ve,eE as qe}from"./vendor-COjCG5sX.js";import{P as Fe}from"./YesNoButton-DD4RFE30.js";import{e as O,A as j,p as Ae,m as T,b as ne,U as g}from"./index-ClP83spC.js";import{b as P,q as Be,n as J,A as Le,g as F,u as Ie,a as Me}from"./UseForm-DUtLE7-5.js";import{u as ze}from"./DesktopAppView-DxQJo3T-.js";import{f as Oe}from"./formatters-BZ5YEOyk.js";import{c as Pe}from"./UseStockAdjustActions-DrD9IiH8.js";import{u as X,p as De,v as Ee,x as Ve,w as Qe,s as Ne,B as Je,t as Ue,o as We,I as K,K as oe,R as Ge,a as Ze}from"./InvenTreeTable-BLgfUICM.js";import{j as re,P as de,D as He,B as I,h as Xe,l as Ke}from"./ColumnRenderers-g3zQL0h_.js";import{A as M}from"./ActionButton-DLsRvAT1.js";import{P as H}from"./index-dkDFLfDd.js";import{O as Ye}from"./OrderPartsWizard-CHxSYjNR.js";import{u as $e,a as et,b as tt}from"./BuildForms-DlhAzCk8.js";import{u as st}from"./UseStatusCodes-ChLgWVsN.js";import{R as at}from"./RowExpansionIcon-DiKqNCIG.js";import{a as ce}from"./ThemeContext-B85sS1BU.js";function yt({buildId:o,partId:a}){const y=d.useMemo(()=>o?"build-test-results":"part-test-results",[o]),m=X(y),v=ze(),{data:b}=ge({queryKey:["build-test-templates",a,o],queryFn:async()=>a?v.get(O(j.part_test_template_list),{params:{part:a,include_inherited:!0,enabled:!0,required:!0}}).then(_=>_.data):[]});d.useEffect(()=>{m.refreshTable()},[b]);const[p,r]=d.useState(0),[k,S]=d.useState(void 0),A=Pe({partId:a,itemId:p,templateId:k}),B=P({url:O(j.stock_test_result_list),title:t._({id:"VzkBcq"}),fields:A,initialData:{template:k,result:!0},onFormSuccess:()=>m.refreshTable(),successMessage:t._({id:"VivtT0"})}),U=d.useMemo(()=>{const _={...A};return delete _.attachment,delete _.stock_item,_.template.disabled=!1,_},[a,A]),W=d.useCallback((_,x)=>m.selectedRecords.map(h=>({..._,stock_item:h.pk})),[m.selectedIds]),D=P({url:O(j.stock_test_result_list),title:t._({id:"t+Eo6q"}),fields:U,initialData:{result:!0},onFormSuccess:()=>{m.clearSelectedRecords(),m.refreshTable()},processFormData:W,successMessage:t._({id:"1QgWBV"})}),L=d.useMemo(()=>!b||b.length==0?[]:b.map(_=>({accessor:`test_${_.pk}`,title:_.test_name,sortable:!1,switchable:!0,render:x=>{const h=(x.tests||[]).filter(w=>w.template==_.pk).sort((w,N)=>N.pk-w.pk).shift();if(!h||h.result===void 0)return s.jsxs(z,{gap:"xs",wrap:"nowrap",justify:"space-between",children:[s.jsx(Ce,{color:"lightblue",variant:"filled",children:t._({id:"4bobEy"})}),s.jsx(Re,{label:t._({id:"VzkBcq"}),children:s.jsx(we,{size:"lg",color:"green","aria-label":"add-test-result",variant:"transparent",onClick:w=>{Ae(w),r(x.pk),S(_.pk),B.open()},children:s.jsx(ee,{})})})]});const R=[];return h.value&&R.push(s.jsxs(u,{size:"sm",children:[t._({id:"wMHvYH"}),": ",h.value]},"value")),h.notes&&R.push(s.jsxs(u,{size:"sm",children:[t._({id:"1DBGsz"}),": ",h.notes]},"notes")),h.date&&R.push(s.jsxs(u,{size:"sm",children:[t._({id:"mYGY3B"}),": ",Oe(h.date)]},"date")),h.user_detail&&R.push(s.jsx(Be,{instance:h.user_detail},"user")),s.jsx(J,{value:s.jsx(Fe,{value:h.result}),title:_.test_name,extra:R})}})),[b]),E=d.useMemo(()=>[...[{accessor:"stock",title:t._({id:"igx8Og"}),sortable:!0,switchable:!1,render:x=>{if(x.serial)return`# ${x.serial}`;{const C=[];return x.batch&&C.push(s.jsxs(u,{size:"sm",children:[t._({id:"Vea6Aj"}),": ",x.batch]},"batch")),s.jsx(J,{value:s.jsxs(u,{children:[t._({id:"VbWX2u"}),": ",x.quantity]}),title:t._({id:"gILim+"}),extra:C})}}},{accessor:"batch",title:t._({id:"Vea6Aj"}),sortable:!0,switchable:!0},re({accessor:"location_detail"})],...L],[L]),V=d.useMemo(()=>[{name:"is_building",label:t._({id:"BE5Q6v"}),description:t._({id:"AO8gAN"})},De(),Ee(),Ve(),Qe(),Ne(),Je(),Ue(),{name:"status",label:t._({id:"uAQUqI"}),description:t._({id:"+Jr1e4"}),choiceFunction:We(T.stockitem)}],[]),q=d.useMemo(()=>[s.jsx(Le,{tooltip:t._({id:"VzkBcq"}),disabled:!m.hasSelectedRecords,onClick:_=>{D.open()}},"add-test-result")],[m.hasSelectedRecords]),Q=d.useCallback(_=>[{icon:s.jsx(ee,{}),color:"green",title:t._({id:"VzkBcq"}),onClick:x=>{r(_.pk),S(void 0),B.open()}}],[]);return s.jsxs(s.Fragment,{children:[B.modal,D.modal,s.jsx(K,{url:O(j.stock_item_list),tableState:m,columns:E,props:{params:{part_detail:!0,location_detail:!0,tests:!0,build:o},enableSelection:!0,rowActions:Q,tableFilters:V,tableActions:q,modelType:T.stockitem}})]})}function it({lineItem:o,onEditAllocation:a,onDeleteAllocation:y}){const m=ne(),v=ce(),b=X("buildline-subtable"),p=d.useMemo(()=>[de({part:"part_detail"}),{accessor:"quantity",title:t._({id:"VbWX2u"}),render:k=>{var S;return(S=k.stock_item_detail)!=null&&S.serial?`# ${k.stock_item_detail.serial}`:k.quantity}},{accessor:"stock_item_detail.batch",title:t._({id:"rsx3xA"})},re({accessor:"location_detail"})],[]),r=d.useCallback(k=>[oe({title:t._({id:"f6f1i/"}),modelType:T.stockitem,modelId:k.stock_item,navigate:v}),Ge({hidden:!a||!m.hasChangeRole(g.build),onClick:()=>{a==null||a(k.pk)}}),Ze({hidden:!y||!m.hasDeleteRole(g.build),onClick:()=>{y==null||y(k.pk)}})],[m,a,y]);return s.jsx(Se,{p:"xs",children:s.jsx(K,{tableState:b,columns:p,tableData:o.filteredAllocations??o.allocations,props:{minHeight:200,enableSearch:!1,enableRefresh:!1,enableColumnSwitching:!1,enableFilters:!1,rowActions:r,noRecordsText:""}})})}function gt({build:o,output:a,params:y={}}){const m=ne(),v=ce(),b=st({modelType:T.build}),p=d.useMemo(()=>!!(a!=null&&a.pk),[a]),r=X(p?"buildline-output":"buildline"),k=d.useMemo(()=>(o==null?void 0:o.status)==b.PRODUCTION||(o==null?void 0:o.status)==b.PENDING||(o==null?void 0:o.status)==b.ON_HOLD,[o,b]),S=d.useMemo(()=>[{name:"allocated",label:t._({id:"A/ybx7"}),description:t._({id:"/EiduX"})},{name:"consumed",label:t._({id:"XNITBt"}),description:t._({id:"ATuQJ1"})},{name:"available",label:t._({id:"csDS2L"}),description:t._({id:"Dg4tQl"})},{name:"consumable",label:t._({id:"duCsZf"}),description:t._({id:"4xoOP+"})},{name:"optional",label:t._({id:"LLAa/9"}),description:t._({id:"JZ0XU+"})},{name:"assembly",label:t._({id:"WL36Yh"}),description:t._({id:"yTd5+B"})},{name:"testable",label:t._({id:"bJsTOf"}),description:t._({id:"LCdyP7"})},{name:"tracked",label:t._({id:"EaG6cP"}),description:t._({id:"lY29Qz"})}],[]),A=d.useCallback(e=>{const i=(e==null?void 0:e.bom_item_detail)??{},l=[];let n=e==null?void 0:e.available_stock;e.available_substitute_stock>0&&(n+=e.available_substitute_stock,l.push(s.jsx(u,{size:"sm",children:t._({id:"XTe+lK"})},"substitite"))),i.allow_variants&&e.available_variant_stock>0&&(n+=e.available_variant_stock,l.push(s.jsx(u,{size:"sm",children:t._({id:"LdvJ9e"})},"variant"))),e.in_production>0&&l.push(s.jsxs(u,{size:"sm",children:[t._({id:"G1xXyB"}),": ",F(e.in_production)]},"production")),e.on_order>0&&l.push(s.jsxs(u,{size:"sm",children:[t._({id:"/MB+gl"}),": ",F(e.on_order)]},"on-order")),e.external_stock>0&&l.push(s.jsxs(u,{size:"sm",children:[t._({id:"e8fwfT"}),": ",F(e.external_stock)]},"external"));const c=n>=e.quantity-e.allocated;return c||l.push(s.jsx(u,{c:"orange",size:"sm",children:t._({id:"R7+e2m"})},"insufficient")),s.jsx(J,{icon:c?"info":"exclamation",iconColor:c?"blue":"orange",value:n>0?`${F(n)}`:s.jsx(u,{c:"red",style:{fontStyle:"italic"},children:t._({id:"a5n/wL"})}),title:t._({id:"oGd3rK"}),extra:l})},[]),B=d.useMemo(()=>[de({accessor:"bom_item",part:"part_detail",ordering:"part",sortable:!0,switchable:!1,render:e=>{const i=e.allocatedQuantity>0;return s.jsxs(z,{wrap:"nowrap",children:[s.jsx(at,{enabled:i,expanded:r.isRowExpanded(e.pk)}),s.jsx(Ke,{part:e.part_detail})]})}}),{accessor:"part_detail.IPN",sortable:!1,title:t._({id:"3wXEsN"})},He({accessor:"part_detail.description"}),{accessor:"bom_item_detail.reference",ordering:"reference",sortable:!0,title:t._({id:"N2C89m"})},I({accessor:"bom_item_detail.optional",ordering:"optional",hidden:p,defaultVisible:!1}),I({accessor:"bom_item_detail.consumable",ordering:"consumable",hidden:p,defaultVisible:!1}),I({accessor:"bom_item_detail.allow_variants",ordering:"allow_variants",hidden:p,defaultVisible:!1}),I({accessor:"bom_item_detail.inherited",ordering:"inherited",title:t._({id:"UF/nv9"}),hidden:p,defaultVisible:!1}),I({accessor:"part_detail.trackable",ordering:"trackable",hidden:p,defaultVisible:!1}),{accessor:"bom_item_detail.quantity",sortable:!0,title:t._({id:"O7oMsT"}),defaultVisible:!1,ordering:"unit_quantity",render:e=>{var i,l;return s.jsxs(z,{justify:"space-between",wrap:"nowrap",children:[s.jsx(u,{children:(i=e.bom_item_detail)==null?void 0:i.quantity}),((l=e==null?void 0:e.part_detail)==null?void 0:l.units)&&s.jsxs(u,{size:"xs",children:["[",e.part_detail.units,"]"]})]})}},{accessor:"quantity",title:t._({id:"D91mkk"}),sortable:!0,defaultVisible:!1,switchable:!1,render:e=>{var l,n,c,f;const i=[];return(l=e==null?void 0:e.bom_item_detail)!=null&&l.setup_quantity&&i.push(s.jsxs(u,{size:"sm",children:[t._({id:"uweQpR"}),":"," ",F(e.bom_item_detail.setup_quantity)]},"setup-quantity")),(n=e==null?void 0:e.bom_item_detail)!=null&&n.attrition&&i.push(s.jsxs(u,{size:"sm",children:[t._({id:"SXygdJ"}),": ",e.bom_item_detail.attrition,"%"]},"attrition")),(c=e==null?void 0:e.bom_item_detail)!=null&&c.rounding_multiple&&i.push(s.jsxs(u,{size:"sm",children:[t._({id:"RKbJ2k"}),":"," ",e.bom_item_detail.rounding_multiple]},"rounding-multiple")),s.jsx(J,{title:t._({id:"mbcLng"}),extra:i,value:s.jsxs(z,{justify:"space-between",wrap:"nowrap",children:[s.jsx(u,{children:F(e.requiredQuantity)}),((f=e==null?void 0:e.part_detail)==null?void 0:f.units)&&s.jsxs(u,{size:"xs",children:["[",e.part_detail.units,"]"]})]})})}},{accessor:"available_stock",sortable:!0,switchable:!1,render:A},{accessor:"in_production",render:e=>{var i;return e.scheduled_to_build>0?s.jsx(H,{progressLabel:!0,value:e.in_production,maximum:e.scheduled_to_build}):(i=e.part_detail)!=null&&i.is_assembly?0:"-"}},Xe({accessor:"on_order",defaultVisible:!1}),{accessor:"allocated",switchable:!1,sortable:!0,hidden:!k,minWidth:125,render:e=>{var n,c;if((n=e==null?void 0:e.bom_item_detail)!=null&&n.consumable)return s.jsx(u,{size:"sm",style:{fontStyle:"italic"},children:t._({id:"f/GbFw"})});const i=e.allocatedQuantity??0;let l=Math.max(0,e.quantity-e.consumed);return a!=null&&a.pk&&(l=(c=e.bom_item_detail)==null?void 0:c.quantity),i<=0&&l<=0?s.jsxs(z,{gap:"xs",wrap:"nowrap",children:[s.jsx(Te,{size:16,color:"green"}),s.jsx(u,{size:"sm",style:{fontStyle:"italic"},children:e.consumed>=e.quantity?t._({id:"e02p4q"}):t._({id:"rHo/AM"})})]}):s.jsx(H,{progressLabel:!0,value:i,maximum:l})}},{accessor:"consumed",sortable:!0,hidden:!!(a!=null&&a.pk),minWidth:125,render:e=>{var i;return(i=e==null?void 0:e.bom_item_detail)!=null&&i.consumable?s.jsx(u,{style:{fontStyle:"italic"},children:t._({id:"f/GbFw"})}):s.jsx(H,{progressLabel:!0,value:e.consumed,maximum:e.requiredQuantity})}}],[p,k,r,a]),U=$e({create:!0,modalId:"new-build-order"}),[W,D]=d.useState({}),[L,E]=d.useState(null),[V,q]=d.useState([]),Q=P({url:j.build_order_list,title:t._({id:"UcPKar"}),fields:U,modalId:"new-build-order",initialData:W,follow:!0,modelType:T.build}),_=P({url:j.build_order_auto_allocate,pk:o.pk,title:t._({id:"L1LMmH"}),fields:{location:{filters:{structural:!1}},exclude_location:{},interchangeable:{},substitutes:{},optional_items:{}},initialData:{location:o.take_from,interchangeable:!0,substitutes:!0,optional_items:!1},successMessage:t._({id:"xYIlpM"}),table:r,preFormContent:s.jsx(te,{color:"green",title:t._({id:"PjEJ0F"}),children:s.jsx(u,{children:t._({id:"E2byp7"})})})}),x=et({build:o,output:a,outputId:(a==null?void 0:a.pk)??null,buildId:o.pk,lineItems:V,onFormSuccess:()=>{r.clearSelectedRecords(),r.refreshTable()}}),C=P({url:j.build_order_deallocate,pk:o.pk,title:t._({id:"ZZL0Jx"}),fields:{build_line:{hidden:!0},output:{hidden:!0}},initialData:{build_line:L,output:(a==null?void 0:a.pk)??null},preFormContent:s.jsx(te,{color:"red",title:t._({id:"ZZL0Jx"}),children:L==null?s.jsx(u,{children:t._({id:"9dNtWo"})}):s.jsx(u,{children:t._({id:"L01aET"})})}),successMessage:t._({id:"er7tfw"}),onFormSuccess:()=>{r.clearSelectedRecords(),r.refreshTable()}}),[h,R]=d.useState(0),w=Ie({url:j.build_item_list,pk:h,title:t._({id:"Tqnsor"}),fields:{stock_item:{disabled:!0},quantity:{}},table:r}),N=Me({url:j.build_item_list,pk:h,title:t._({id:"nV5okC"}),table:r}),[ue,Y]=d.useState([]),G=Ye({parts:ue}),Z=tt({buildId:o.pk,buildLines:V,onFormSuccess:()=>{r.clearSelectedRecords(),r.refreshTable()}}),me=d.useCallback(e=>{var $;const i=e.part_detail??{},l=o.status==b.PRODUCTION,n=(($=e.bom_item_detail)==null?void 0:$.consumable)??!1,c=(i==null?void 0:i.trackable)??!1,f=!!(a!=null&&a.pk),he=Math.max(0,e.quantity-e.consumed-e.allocated),fe=l&&!n&&!c&&e.allocated>0&&m.hasChangeRole(g.build),xe=l&&!n&&m.hasChangeRole(g.build)&&he>0&&e.trackable==f,ke=l&&!n&&m.hasChangeRole(g.build)&&e.allocated>0&&e.trackable==f,je=!n&&m.hasAddRole(g.purchase_order)&&i.purchaseable,ye=!n&&m.hasAddRole(g.build)&&i.assembly;return[{icon:s.jsx(se,{}),title:t._({id:"L1LMmH"}),hidden:!xe,color:"green",onClick:()=>{q([e]),x.open()}},{icon:s.jsx(ae,{}),title:t._({id:"8nBqTf"}),color:"green",hidden:!fe||f,onClick:()=>{q([e]),Z.open()}},{icon:s.jsx(ie,{}),title:t._({id:"ZZL0Jx"}),hidden:!ke,color:"red",onClick:()=>{E(e.pk),C.open()}},{icon:s.jsx(le,{}),title:t._({id:"cUzrZK"}),hidden:!je,color:"blue",onClick:()=>{Y([e.part_detail]),G.openWizard()}},{icon:s.jsx(ve,{}),title:t._({id:"vgTd7I"}),hidden:!ye,color:"blue",onClick:()=>{D({part:e.part,parent:o.pk,quantity:e.quantity-e.allocated}),Q.open()}},oe({title:t._({id:"4BxQBj"}),modelType:T.part,modelId:e.part,navigate:v})]},[m,v,a,o,b]),_e=d.useMemo(()=>{const e=o.status==b.PRODUCTION,i=m.hasChangeRole(g.build),l=e&&i;return[s.jsx(M,{icon:s.jsx(qe,{}),tooltip:t._({id:"PjEJ0F"}),hidden:!l||p,color:"blue",onClick:()=>{_.open()}},"auto-allocate"),s.jsx(M,{hidden:!m.hasAddRole(g.purchase_order),disabled:!r.hasSelectedRecords,icon:s.jsx(le,{}),color:"blue",tooltip:t._({id:"3u5ICq"}),onClick:()=>{Y(r.selectedRecords.filter(n=>{var c,f;return((c=n.part_detail)==null?void 0:c.purchaseable)&&((f=n.part_detail)==null?void 0:f.active)}).map(n=>n.part_detail)),G.openWizard()}},"order-parts"),s.jsx(M,{icon:s.jsx(se,{}),tooltip:t._({id:"L1LMmH"}),hidden:!l,disabled:!r.hasSelectedRecords,color:"green",onClick:()=>{let n=r.selectedRecords.filter(c=>c.allocatedQuantity<c.requiredQuantity).filter(c=>{var f;return!((f=c.bom_item_detail)!=null&&f.consumable)});p?n=n.filter(c=>c.trackable):n=n.filter(c=>!c.trackable),q(n),x.open()}},"allocate-stock"),s.jsx(M,{icon:s.jsx(ie,{}),tooltip:t._({id:"ZZL0Jx"}),hidden:!l||p,disabled:r.hasSelectedRecords,color:"red",onClick:()=>{E(null),C.open()}},"deallocate-stock"),s.jsx(M,{icon:s.jsx(ae,{}),tooltip:t._({id:"8nBqTf"}),hidden:!l||p,disabled:!r.hasSelectedRecords,color:"green",onClick:()=>{q(r.selectedRecords),Z.open()}},"consume-stock")]},[m,o,b,p,r.hasSelectedRecords,r.selectedRecords]),be=d.useCallback(e=>e.map(i=>{let l=[...i.allocations];a!=null&&a.pk&&(l=l.filter(f=>f.install_into==a.pk));let n=0,c=i.quantity;return l.forEach(f=>{n+=f.quantity}),a!=null&&a.quantity&&i.bom_item_detail&&(c=a.quantity*i.bom_item_detail.quantity),{...i,filteredAllocations:l,requiredQuantity:c,allocatedQuantity:n}}),[a]),pe=d.useMemo(()=>({allowMultiple:!0,expandable:({record:e})=>r.isRowExpanded(e.pk)||e.allocatedQuantity>0,content:({record:e})=>s.jsx(it,{lineItem:e,onEditAllocation:i=>{R(i),w.open()},onDeleteAllocation:i=>{R(i),N.open()}})}),[r.isRowExpanded,a]);return s.jsxs(s.Fragment,{children:[_.modal,Q.modal,x.modal,C.modal,w.modal,N.modal,Z.modal,G.wizard,s.jsx(K,{url:O(j.build_line_list),tableState:r,columns:B,props:{params:{...y,build:o.pk,assembly_detail:!1,part_detail:!0},tableActions:_e,tableFilters:S,rowActions:me,dataFormatter:be,enableDownload:!0,enableSelection:!0,enableLabels:!0,modelType:T.buildline,onCellClick:()=>{},rowExpansion:pe}})]})}export{it as B,yt as P,gt as a};
//# sourceMappingURL=BuildLineTable-DhaH4Pe-.js.map
