import{r as s,j as t,ed as re,ee as ue,ap as _e,aL as S,ef as ie,bx as fe,al as xe,i as a,cu as h,N as ge,c5 as me,c6 as he,bR as g,cG as E,eg as je,G as be,z as pe,aG as ye,bh as ve,ah as Ce,aE as ke}from"./vendor-COjCG5sX.js";import{A as f}from"./ActionButton-DLsRvAT1.js";import{f as w,m as ne,e as T,A}from"./index-ClP83spC.js";import{r as Fe,b as Ee,d as Se,T as Te,S as te,t as b}from"./UseForm-DUtLE7-5.js";import{R as Ae}from"./RemoveRowButton-CcCl0sVr.js";import{P as we}from"./index-dkDFLfDd.js";import{S as De,I as r}from"./ThemeContext-B85sS1BU.js";import{u as Ie,a as Oe}from"./UseGenerator-CdxkBrcC.js";function ze({supplierId:e,orderId:i,create:x}){const c=w(),[o,l]=s.useState(""),[u,m]=s.useState(!0),[d,C]=s.useState({});return s.useEffect(()=>{u&&l("")},[u]),s.useEffect(()=>{m(o==="")},[o]),s.useMemo(()=>{const j={order:{filters:{supplier_detail:!0},disabled:!0},part:{filters:{part_detail:!0,supplier_detail:!0,active:!0,part_active:!0},onValueChange:(p,y)=>{C((y==null?void 0:y.part_detail)??{})},adjustFilters:p=>({...p.filters,supplier:e})},quantity:{},reference:{},purchase_price:{icon:t.jsx(ke,{}),value:o,onValueChange:l},purchase_price_currency:{icon:t.jsx(ie,{})},auto_pricing:{value:u,onValueChange:m},target_date:{icon:t.jsx(S,{})},destination:{icon:t.jsx(Ce,{})},build_order:{disabled:!(d!=null&&d.assembly),filters:{external:!0,outstanding:!0,part:d==null?void 0:d.pk}},notes:{icon:t.jsx(ve,{})},link:{icon:t.jsx(ye,{})}};return c.isSet("BUILDORDER_EXTERNAL_BUILDS",!1)||delete j.build_order,x&&(j.merge_items={}),j},[x,i,d,c,e,u,o])}function He({supplierId:e,duplicateOrderId:i}){const x=w();return s.useMemo(()=>{const c={reference:{icon:t.jsx(xe,{})},description:{},supplier:{value:e,disabled:!!i||!!e,filters:{is_supplier:!0,active:!0}},supplier_reference:{},project_code:{icon:t.jsx(fe,{})},order_currency:{icon:t.jsx(ie,{})},start_date:{icon:t.jsx(S,{})},target_date:{icon:t.jsx(S,{})},destination:{filters:{structural:!1}},link:{},contact:{icon:t.jsx(_e,{}),adjustFilters:o=>({...o.filters,company:o.data.supplier})},address:{icon:t.jsx(ue,{}),adjustFilters:o=>({...o.filters,company:o.data.supplier})},responsible:{filters:{is_active:!0},icon:t.jsx(re,{})}};return i&&(c.duplicate={children:{order_id:{hidden:!0,value:i},copy_lines:{},copy_extra_lines:{}}}),x.isSet("PROJECT_CODES_ENABLED",!0)||delete c.project_code,c},[i,e,x])}function Ve({props:e,record:i,statuses:x}){var N,P,B,M,R,G,z,H,K,U,J,Y,X,W,Q,Z,$;const[c,{open:o,close:l}]=h(!1,{onClose:()=>e.changeFn(e.idx,"barcode",void 0)}),[u,m]=h(!1,{onClose:()=>e.changeFn(e.idx,"location",void 0)}),d=s.useMemo(()=>{var n;return((n=i.part_detail)==null?void 0:n.trackable)??!1},[i]),C=w();s.useEffect(()=>{i.destination&&(e.changeFn(e.idx,"location",i.destination),m.open())},[i.destination]);const D=Ie({isEnabled:()=>v,onGenerate:n=>{n&&e.changeFn(e.idx,"batch_code",n)}}),j=Oe({isEnabled:()=>v&&d,onGenerate:n=>{n&&e.changeFn(e.idx,"serial_numbers",n)}}),[p,y]=h(!1,{onClose:()=>{e.changeFn(e.idx,"packaging",void 0)}}),[I,ae]=h(!1,{onClose:()=>{e.changeFn(e.idx,"note",void 0)}}),[v,le]=h(!1,{onClose:()=>{e.changeFn(e.idx,"batch_code",void 0),e.changeFn(e.idx,"serial_numbers",void 0)},onOpen:()=>{var n,_;D.update({part:(n=i==null?void 0:i.supplier_part_detail)==null?void 0:n.part,order:i==null?void 0:i.order}),d?j.update({part:(_=i==null?void 0:i.supplier_part_detail)==null?void 0:_.part,quantity:e.item.quantity}):e.changeFn(e.idx,"serial_numbers",void 0)}}),[O,se]=h(!1,{onOpen:()=>{var _;const n=(_=i.part_detail)==null?void 0:_.default_expiry;n!==void 0&&n>0&&e.changeFn(e.idx,"expiry_date",Se().add(n,"day").format("YYYY-MM-DD"))},onClose:()=>{e.changeFn(e.idx,"expiry_date",void 0)}}),[V,oe]=h(!1,{onClose:()=>e.changeFn(e.idx,"status",void 0)}),[k,q]=s.useState(""),[F,L]=s.useState(void 0);s.useEffect(()=>{e.changeFn(e.idx,"barcode",F)},[F]);const de=s.useMemo(()=>d?a._({id:"W778m0"}):a._({id:"K5pQC8"}),[d]);s.useEffect(()=>{if(!c)return;const n=setTimeout(()=>{L(k.length?k:null),l(),q("")},500);return()=>clearTimeout(n)},[k]);const ce=s.useMemo(()=>{var _,ee;const n=a._({id:"RL9/J8"});return location===null?n:location===i.destination?a._({id:"LNKjyK"}):!i.destination&&!i.destination_detail&&i.part_detail&&location===((_=i.part_detail)==null?void 0:_.category_default_location)?a._({id:"q3WAIO"}):!i.destination&&i.destination_detail&&location===i.destination_detail.pk&&i.received>0?a._({id:"K1Mf+T"}):(ee=i.part_detail)!=null&&ee.default_location&&location===i.part_detail.default_location?a._({id:"ALFlH9"}):n},[location]);return t.jsxs(t.Fragment,{children:[t.jsx(ge,{opened:c,onClose:l,title:t.jsx(De,{children:a._({id:"fNvDwV"})}),children:t.jsx(me,{children:t.jsx(he,{label:"Barcode data","data-autofocus":!0,value:k,onChange:n=>q(n.target.value)})})}),t.jsxs(g.Tr,{children:[t.jsx(g.Td,{children:t.jsxs(E,{gap:"sm",align:"center",children:[t.jsx(Te,{size:40,src:i.part_detail.thumbnail,align:"center"}),t.jsx("div",{children:i.part_detail.name})]})}),t.jsx(g.Td,{children:i.supplier_part_detail.SKU}),t.jsx(g.Td,{children:t.jsx(we,{value:i.received,maximum:i.quantity,progressLabel:!0})}),t.jsx(g.Td,{style:{whiteSpace:"nowrap"},children:t.jsx(te,{fieldName:"quantity",fieldDefinition:{field_type:"number",value:e.item.quantity,onValueChange:n=>{e.changeFn(e.idx,"quantity",n),j.update({quantity:n})}},error:(P=(N=e.rowErrors)==null?void 0:N.quantity)==null?void 0:P.message})}),t.jsx(g.Td,{style:{width:"1%",whiteSpace:"nowrap"},children:t.jsxs(E,{gap:"1px",children:[t.jsx(f,{size:"sm",onClick:()=>m.toggle(),icon:t.jsx(r,{icon:"location"}),tooltip:a._({id:"TJYLHZ"}),tooltipAlignment:"top",variant:u?"filled":"transparent"}),t.jsx(f,{size:"sm",onClick:()=>le.toggle(),icon:t.jsx(r,{icon:"batch_code"}),tooltip:de,tooltipAlignment:"top",variant:v?"filled":"transparent"}),C.isSet("STOCK_ENABLE_EXPIRY")&&t.jsx(f,{size:"sm",onClick:()=>se.toggle(),icon:t.jsx(je,{}),tooltip:a._({id:"okjJiB"}),tooltipAlignment:"top",variant:O?"filled":"transparent"}),t.jsx(f,{size:"sm",icon:t.jsx(r,{icon:"packaging"}),tooltip:a._({id:"O7MZ1G"}),tooltipAlignment:"top",onClick:()=>y.toggle(),variant:p?"filled":"transparent"}),t.jsx(f,{onClick:()=>oe.toggle(),icon:t.jsx(r,{icon:"status"}),tooltip:a._({id:"Gt4cm5"}),tooltipAlignment:"top",variant:V?"filled":"transparent"}),t.jsx(f,{icon:t.jsx(r,{icon:"note"}),tooltip:a._({id:"nxv8yE"}),tooltipAlignment:"top",variant:I?"filled":"transparent",onClick:()=>ae.toggle()}),F?t.jsx(f,{icon:t.jsx(r,{icon:"unlink"}),tooltip:a._({id:"ut1J8k"}),tooltipAlignment:"top",variant:"filled",color:"red",onClick:()=>L(void 0)}):t.jsx(f,{icon:t.jsx(r,{icon:"barcode"}),tooltip:a._({id:"fNvDwV"}),tooltipAlignment:"top",variant:"transparent",onClick:()=>o()})]})}),t.jsx(g.Td,{children:t.jsx(Ae,{onClick:()=>e.removeFn(e.idx)})})]}),u&&t.jsx(g.Tr,{children:t.jsx(g.Td,{colSpan:10,children:t.jsxs(be,{grow:!0,preventGrowOverflow:!1,justify:"flex-apart",p:"xs",children:[t.jsx(pe,{flex:0,p:"xs",children:t.jsx(r,{icon:"downright"})}),t.jsx(te,{fieldDefinition:{field_type:"related field",model:ne.stocklocation,api_url:T(A.stock_location_list),filters:{structural:!1},onValueChange:n=>{e.changeFn(e.idx,"location",n)},description:ce,value:e.item.location,label:a._({id:"wJijgU"}),icon:t.jsx(r,{icon:"location"})},defaultValue:i.destination??(i.destination_detail?i.destination_detail.pk:null)}),t.jsxs(E,{style:{marginBottom:"7px"},children:[(((B=i.part_detail)==null?void 0:B.default_location)||((M=i.part_detail)==null?void 0:M.category_default_location))&&t.jsx(f,{icon:t.jsx(r,{icon:"default_location"}),tooltip:a._({id:"j9qXAA"}),onClick:()=>{var n,_;return e.changeFn(e.idx,"location",((n=i.part_detail)==null?void 0:n.default_location)??((_=i.part_detail)==null?void 0:_.category_default_location))},tooltipAlignment:"top"}),i.destination&&t.jsx(f,{icon:t.jsx(r,{icon:"destination"}),tooltip:a._({id:"Co8OYS"}),onClick:()=>e.changeFn(e.idx,"location",i.destination),tooltipAlignment:"top"}),!i.destination&&i.destination_detail&&i.received>0&&t.jsx(f,{icon:t.jsx(r,{icon:"repeat_destination"}),tooltip:a._({id:"CKgjtC"}),onClick:()=>e.changeFn(e.idx,"location",i.destination_detail.pk),tooltipAlignment:"top"})]})]})})}),t.jsx(b,{visible:v,onValueChange:n=>{e.changeFn(e.idx,"batch_code",n)},fieldName:"batch_code",fieldDefinition:{field_type:"string",label:a._({id:"Vea6Aj"}),description:a._({id:"s848yO"}),value:e.item.batch_code},error:(G=(R=e.rowErrors)==null?void 0:R.batch_code)==null?void 0:G.message}),t.jsx(b,{visible:v&&d,onValueChange:n=>e.changeFn(e.idx,"serial_numbers",n),fieldName:"serial_numbers",fieldDefinition:{field_type:"string",label:a._({id:"VzQT2x"}),description:a._({id:"ig+UDq"}),value:e.item.serial_numbers},error:(H=(z=e.rowErrors)==null?void 0:z.serial_numbers)==null?void 0:H.message}),C.isSet("STOCK_ENABLE_EXPIRY")&&t.jsx(b,{visible:O,onValueChange:n=>e.changeFn(e.idx,"expiry_date",n),fieldName:"expiry_date",fieldDefinition:{field_type:"date",label:a._({id:"uaSvqt"}),description:a._({id:"ICgiSv"}),value:e.item.expiry_date},error:(U=(K=e.rowErrors)==null?void 0:K.expiry_date)==null?void 0:U.message}),t.jsx(b,{visible:p,onValueChange:n=>e.changeFn(e.idx,"packaging",n),fieldName:"packaging",fieldDefinition:{field_type:"string",label:a._({id:"pD/Ew0"})},defaultValue:(J=i==null?void 0:i.supplier_part_detail)==null?void 0:J.packaging,error:(X=(Y=e.rowErrors)==null?void 0:Y.packaging)==null?void 0:X.message}),t.jsx(b,{visible:V,defaultValue:10,fieldName:"status",onValueChange:n=>e.changeFn(e.idx,"status",n),fieldDefinition:{field_type:"choice",api_url:T(A.stock_status),choices:x,label:a._({id:"uAQUqI"})},error:(Q=(W=e.rowErrors)==null?void 0:W.status)==null?void 0:Q.message}),t.jsx(b,{visible:I,fieldName:"note",onValueChange:n=>e.changeFn(e.idx,"note",n),fieldDefinition:{field_type:"string",label:a._({id:"KiJn9B"})},error:($=(Z=e.rowErrors)==null?void 0:Z.note)==null?void 0:$.message})]})}function Ke(e){const i=s.useMemo(()=>Fe(ne.stockitem),[]),x=Object.fromEntries(e.items.map(l=>[l.pk,l])),c=e.items.filter(l=>l.quantity!==l.received),o=s.useMemo(()=>({id:{value:e.orderPk,hidden:!0},items:{field_type:"table",value:c.map((l,u)=>{var m;return{line_item:l.pk,location:l.destination??((m=l.destination_detail)==null?void 0:m.pk)??null,quantity:l.quantity-l.received,expiry_date:null,batch_code:"",serial_numbers:"",status:10,barcode:null}}),modelRenderer:l=>{const u=x[l.item.line_item];return t.jsx(Ve,{props:l,record:u,statuses:i},u.pk)},headers:[{title:a._({id:"vgP+9p"}),style:{minWidth:"200px"}},{title:a._({id:"y90mqQ"}),style:{minWidth:"200px"}},{title:a._({id:"fZ5Vnu"}),style:{minWidth:"200px"}},{title:a._({id:"VbWX2u"}),style:{width:"200px"}},{title:a._({id:"7L01XJ"})},{title:"",style:{width:"50px"}}]},location:{filters:{structural:!1}}}),[c,e,i]);return Ee({...e.formProps,url:T(A.purchase_order_receive,e.orderPk),title:a._({id:"MXlhj9"}),fields:o,initialData:{location:e.destinationPk},size:"80%",successMessage:a._({id:"zFmwOr"})})}export{Ke as a,ze as b,He as u};
//# sourceMappingURL=PurchaseOrderForms-DPLnYzsw.js.map
